<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Emotion Ad — GitHub Models + Face Lock</title>
<style>
  :root { color-scheme: dark; }
  body { font-family: system-ui, Arial, sans-serif; margin:16px; background:#0f1115; color:#fff; }
  .row{display:flex;flex-wrap:wrap;gap:12px;align-items:flex-start}
  .panel{flex:1 1 360px;border:1px solid #222;border-radius:10px;padding:12px;background:#131722}
  label{display:block;margin-top:10px;font-weight:600}
  input[type="text"], input[type="url"]{width:100%;padding:8px 10px;border-radius:8px;border:1px solid #333;background:#161a26;color:#fff}
  button{padding:10px 14px;border:0;border-radius:10px;background:#2a2f3d;color:#fff;cursor:pointer}
  button:disabled{opacity:.55;cursor:not-allowed}
  video{width:100%;border-radius:10px;background:#000}
  .camWrap{position:relative}
  canvas#overlay{position:absolute;inset:0;width:100%;height:100%;border-radius:10px;pointer-events:none}
  #diag{white-space:pre-wrap;font:12px ui-monospace;max-height:260px;overflow:auto;background:#0b1020;border:1px solid #222;border-radius:8px;padding:8px;margin-top:10px}
  .kpi{display:flex;gap:10px;margin-top:10px}
  .kpi>div{flex:1 1 0;background:#101520;border:1px solid #222;border-radius:10px;padding:10px;text-align:center}
  .pill{display:inline-block;padding:2px 8px;border-radius:8px;background:#1f2433;margin-left:8px;font:12px ui-monospace}
  .warn{background:#3b0d0d;color:#ffdada;border:1px solid #5c1212;border-radius:8px;padding:8px 12px;margin-bottom:10px;display:none}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
</style>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.18.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
</head>
<body>
<div id="httpsWarn" class="warn">This page is not secure. Use <b>HTTPS</b> or <b>localhost</b> (camera will fail on <code>file://</code> or plain <code>http://</code>).</div>

<h2>Emotion-Only Ad Test
  <span class="pill">frames: <span id="pFrames">0</span></span>
  <span class="pill">faces: <span id="pFaces">0</span></span>
</h2>

<div class="row">
  <div class="panel" style="flex:1 1 620px;">
    <div class="grid2">
      <div>
        <label>Models URL (GitHub Pages, e.g. https://YOUR.github.io/REPO/models)</label>
        <input id="modelUrl" type="url" placeholder="https://YOUR.github.io/REPO/models" />
        <div style="margin-top:6px;display:flex;gap:8px;flex-wrap:wrap">
          <button id="btnSaveModels">Save</button>
          <button id="btnProbe">Probe</button>
        </div>
      </div>
      <div>
        <label>Ad URL (MP4)</label>
        <input id="adUrl" type="text" value="ads/0813.mp4" />
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <div style="flex:1 1 420px;min-width:300px">
        <video id="ad" controls playsinline></video>
      </div>
      <div class="camWrap" style="flex:1 1 260px;min-width:240px">
        <video id="cam" autoplay muted playsinline></video>
        <canvas id="overlay"></canvas>
      </div>
    </div>

    <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
      <button id="btnCam">Start webcam</button>
      <button id="btnLoad" disabled>Load models</button>
      <button id="btnTest" disabled>Test detection</button>
      <button id="btnPlay" disabled>Play & analyze</button>
      <button id="btnAnalyzeOnly" disabled>Analyze webcam only</button>
      <button id="btnCSV" disabled>Download CSV</button>
      <button id="btnJSON" disabled>Download JSON</button>
      <button id="btnReport" disabled>Generate Report</button>
      <span id="status" style="align-self:center;color:#9aa3b2">Booting…</span>
    </div>

    <div class="kpi">
      <div><div style="color:#9aa3b2">Purchase Intention</div><div id="pi">—</div></div>
      <div><div style="color:#9aa3b2">Brand Perception</div><div id="bp">—</div></div>
      <div><div style="color:#9aa3b2">Awareness</div><div id="awr">—</div></div>
    </div>

    <div id="diag">DIAG:\n</div>
  </div>

  <div class="panel" style="flex:1 1 380px;">
    <b>Report Config (Optional)</b>
    <p style="color:#9aa3b2;margin:6px 0 10px">Set time ranges + images for Logo / CTA / Packshot.</p>
    <label>Logo (mm:ss-mm:ss)</label>
    <input id="logoRange" type="text" placeholder="00:02-00:04" />
    <label>Logo image URL</label>
    <input id="logoImg" type="url" placeholder="https://YOUR.github.io/REPO/assets/logo.png" />
    <label>CTA (mm:ss-mm:ss)</label>
    <input id="ctaRange" type="text" placeholder="00:12-00:15" />
    <label>CTA image URL</label>
    <input id="ctaImg" type="url" placeholder="https://YOUR.github.io/REPO/assets/cta.png" />
    <label>Packshot (mm:ss-mm:ss)</label>
    <input id="packRange" type="text" placeholder="00:18-00:22" />
    <label>Packshot image URL</label>
    <input id="packImg" type="url" placeholder="https://YOUR.github.io/REPO/assets/pack.png" />
  </div>
</div>

<script>
/* ---------- Configurable MODEL URL (GitHub) ---------- */
function getQuery(key){ return new URLSearchParams(location.search).get(key); }
const saved = localStorage.getItem('modelsUrl') || '';
const q = getQuery('models') || '';
const DEFAULT_MODEL_URL = '/models';
let MODEL_URL = q || saved || DEFAULT_MODEL_URL;
document.getElementById('modelUrl').value = MODEL_URL;

/* ---------- DOM ---------- */
const $ = id => document.getElementById(id);
const ad=$('ad'), cam=$('cam'), canv=$('overlay'), ctx=canv.getContext('2d');
const piEl=$('pi'), bpEl=$('bp'), awrEl=$('awr');
const pFramesEl=$('pFrames'), pFacesEl=$('pFaces');
const statusEl=$('status'), diagEl=$('diag');

/* ---------- State ---------- */
const SAMPLE_MS=200, FACE_HINT_TIMEOUT_MS=3500;
let webcamReady=false, modelsReady=false, testPassed=false;
let timer=null, frames=[], faceFrames=0, lastFaceAt=0;

/* ---------- Utils ---------- */
const log = (...a)=> statusEl.textContent = a.join(' ');
const diag = (...a)=>{ console.log('[diag]',...a); diagEl.textContent += a.join(' ') + '\\n'; diagEl.scrollTop = diagEl.scrollHeight; };
const clamp=(x,a,b)=>Math.min(b,Math.max(a,x));
const nowMs=()=>performance.now();

function updateReady(tag=''){
  const ready = webcamReady && modelsReady;
  $('btnLoad').disabled = !webcamReady;
  $('btnAnalyzeOnly').disabled = !ready;
  $('btnTest').disabled = !ready;
  $('btnPlay').disabled = !(ready && testPassed); // face-lock
  diag(`READY? ${ready} (webcam=${webcamReady} models=${modelsReady} test=${testPassed}) ${tag}`);
}

/* ---------- Security hint ---------- */
(function(){
  const ok = (location.protocol==='https:' || location.hostname==='localhost');
  if(!ok) $('httpsWarn').style.display='block';
})();

/* ---------- Probe & Save ---------- */
$('btnProbe').addEventListener('click', async ()=>{
  try{
    const url = `${$('modelUrl').value.replace(/\\/$/,'')}/tiny_face_detector_model-weights_manifest.json?cb=${Date.now()}`;
    const r = await fetch(url, {cache:'no-store'}); diag('Probe:', url, '→', r.status);
    if(!r.ok) throw new Error('Probe failed');
    diag('PROBE OK.');
  }catch(e){ diag('PROBE ERROR:', e.message); alert('Probe failed — check your GitHub URL.'); }
});

$('btnSaveModels').addEventListener('click', ()=>{
  const v = $('modelUrl').value.trim();
  if(!v){ alert('Enter a models URL'); return; }
  MODEL_URL = v.replace(/\\/$/,'');
  localStorage.setItem('modelsUrl', MODEL_URL);
  diag('Saved models URL:', MODEL_URL);
  modelsReady=false; testPassed=false; updateReady('[saved]');
});

/* ---------- Webcam ---------- */
$('btnCam').addEventListener('click', async ()=>{
  try{
    diag('Requesting webcam…');
    const st = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'user', width:{ideal:1280}, height:{ideal:720} }, audio:false });
    cam.srcObject = st; await cam.play(); await new Promise(r => cam.onloadedmetadata = r);
    canv.width = cam.videoWidth || 640; canv.height = cam.videoHeight || 480;
    webcamReady = true; log(`Webcam ready ${canv.width}x${canv.height}`); updateReady('[cam]');
  }catch(e){ diag('Webcam ERROR:', e.message); alert('Camera error: '+e.message); }
});

/* ---------- Model Load (from YOUR GitHub URL) ---------- */
$('btnLoad').addEventListener('click', async ()=>{
  try{
    const base = $('modelUrl').value.trim() || MODEL_URL;
    MODEL_URL = base.replace(/\\/$/,'');
    const need = [
      'tiny_face_detector_model-weights_manifest.json',
      'face_landmark_68_model-weights_manifest.json',
      'face_expression_model-weights_manifest.json'
    ];
    for (const f of need){
      const url = `${MODEL_URL}/${f}?cb=${Date.now()}`;
      const r = await fetch(url, {cache:'no-store'}); diag('Probe:', url, '→', r.status);
      if(!r.ok) throw new Error(`Missing: ${f}`);
    }
    if (faceapi?.tf?.setBackend){ try{ await faceapi.tf.setBackend('webgl'); await faceapi.tf.ready(); diag('TFJS backend: webgl'); }catch(e){ diag('TFJS backend set failed:', e.message); } }
    diag('Loading models from:', MODEL_URL);
    await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
    await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
    await faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL);
    modelsReady = true; diag('MODELS: OK ✔'); updateReady('[models]');
  }catch(e){ diag('Model load ERROR:', e.message); alert('Model load error: '+e.message); }
});

/* ---------- Detection ---------- */
async function detectOnce(videoEl){
  const tries = [
    { inputSize: 512, scoreThreshold: 0.06 },
    { inputSize: 448, scoreThreshold: 0.06 },
    { inputSize: 384, scoreThreshold: 0.06 },
    { inputSize: 320, scoreThreshold: 0.05 },
  ];
  for (const opt of tries){
    const dets = await faceapi
      .detectAllFaces(videoEl, new faceapi.TinyFaceDetectorOptions(opt))
      .withFaceLandmarks().withFaceExpressions();
    if (dets && dets.length){
      return dets.reduce((b,c)=> c.detection.score > (b?.detection.score||0) ? c : b, null);
    }
  }
  return null;
}

$('btnTest').addEventListener('click', async ()=>{
  if(!webcamReady || !modelsReady){ diag('Test blocked: webcam/models not ready'); return; }
  diag('One-frame detection test…');
  const det = await detectOnce(cam);
  if(det){
    const e = det.expressions || {};
    diag(`Face OK score=${det.detection.score.toFixed(3)} | happy=${(e.happy||0).toFixed(3)} sad=${(e.sad||0).toFixed(3)} ang=${(e.angry||0).toFixed(3)} dis=${(e.disgusted||0).toFixed(3)} fear=${(e.fearful||0).toFixed(3)} surp=${(e.surprised||0).toFixed(3)} neut=${(e.neutral||0).toFixed(3)}`);
    testPassed = true; updateReady('[test pass]');
  }else{
    diag('NO FACE — tips: more light, move closer, center face; make sure front camera is selected.');
    testPassed = false; updateReady('[test fail]');
  }
});

/* ---------- Sampling loop & KPIs ---------- */
function pushRow(t, e, seen){
  const row = { t, happy:+(e?.happy||0), sad:+(e?.sad||0), angry:+(e?.angry||0),
                disgusted:+(e?.disgusted||0), fearful:+(e?.fearful||0),
                surprised:+(e?.surprised||0), neutral:+(e?.neutral||0), face: seen?1:0 };
  frames.push(row); pFramesEl.textContent=String(frames.length);
}

async function tick(){
  ctx.clearRect(0,0,canv.width,canv.height);
  if (cam.readyState >= 2) ctx.drawImage(cam, 0, 0, canv.width, canv.height);
  const det = await detectOnce(cam);
  if (det){
    const r = faceapi.resizeResults(det, { width: canv.width, height: canv.height });
    faceapi.draw.drawDetections(canv, r);
    faceapi.draw.drawFaceLandmarks(canv, r);
    const e = det.expressions || {};
    faceFrames++; pFacesEl.textContent=String(faceFrames); lastFaceAt = nowMs();
    pushRow(ad.currentTime||0, e, true);
  }else{
    pushRow(ad.currentTime||0, null, false);
    if (nowMs()-lastFaceAt > FACE_HINT_TIMEOUT_MS){ diag('No face detected → lighting/position check.'); }
  }
}

function calcKPIs(){
  const valid = frames.filter(f=>f.face); const total = valid.length || 1;
  const pos = valid.filter(f => (f.happy>0.30) || (f.surprised>0.30)).length;
  const neg = valid.filter(f => (f.sad>0.30) || (f.angry>0.30) || (f.disgusted>0.30)).length;
  const aware = valid.filter(f => (f.happy>0.15)||(f.sad>0.15)||(f.angry>0.15)||(f.surprised>0.15)||(f.fearful>0.15)).length;
  const PI  = clamp((pos/total)*100,0,100), BP = clamp(((pos-neg)/total)*100 + 50,0,100), AWR = clamp((aware/total)*100,0,100);
  piEl.textContent=PI.toFixed(1); bpEl.textContent=BP.toFixed(1); awrEl.textContent=AWR.toFixed(1);
  return { PI:+PI.toFixed(1), BP:+BP.toFixed(1), AWR:+AWR.toFixed(1) };
}

/* ---------- CSV / JSON / Report ---------- */
function download(name, text, type='text/plain'){ const blob=new Blob([text],{type}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); URL.revokeObjectURL(a.href); }
function framesCSV(rows){ const header=['t','happy','sad','angry','disgusted','fearful','surprised','neutral','face']; return [header.join(',')].concat(rows.map(r=>[r.t,r.happy,r.sad,r.angry,r.disgusted,r.fearful,r.surprised,r.neutral,r.face].map(x=>typeof x==='number'?x.toFixed(4):x).join(','))).join('\\n'); }
function parseTime(t){ if(!t) return null; if(/^\\d+(\\.\\d+)?$/.test(t)) return parseFloat(t); const m=t.match(/^(\\d{1,2}):(\\d{2})(?:\\.(\\d+))?$/); if(!m) return null; const mm=+m[1], ss=+m[2], f=m[3]?parseFloat('0.'+m[3]):0; return mm*60+ss+f; }
function parseRange(r){ if(!r) return null; const m=r.split('-'); if(m.length!==2) return null; const s=parseTime(m[0].trim()), e=parseTime(m[1].trim()); if(isNaN(s)||isNaN(e)||e<=s) return null; return {start:s,end:e}; }
function avg(a){ return a.length? a.reduce((x,y)=>x+y,0)/a.length : 0; }
function statsForRange(fr, range){
  if(!range) return null; const sub=fr.filter(f=>f.face && f.t>=range.start && f.t<=range.end);
  const keys=['happy','sad','angry','disgusted','fearful','surprised','neutral'];
  const avgEmo=Object.fromEntries(keys.map(k=>[k, avg(sub.map(v=>+v[k]||0))]));
  const total=sub.length||1, pos=sub.filter(f=>(f.happy>0.30)||(f.surprised>0.30)).length, neg=sub.filter(f=>(f.sad>0.30)||(f.angry>0.30)||(f.disgusted>0.30)).length, aware=sub.filter(f=>(f.happy>0.15)||(f.sad>0.15)||(f.angry>0.15)||(f.surprised>0.15)||(f.fearful>0.15)).length;
  return { count: sub.length, avgEmo, PI:+( (pos/total)*100 ).toFixed(1), BP:+( ((pos-neg)/total)*100+50 ).toFixed(1), AWR:+( (aware/total)*100 ).toFixed(1) };
}
function buildReportHTML(meta, kpi, fr, segs){
  function fmtTs(s){ const mm=Math.floor(s/60), ss=Math.floor(s%60); return `${mm.toString().padStart(2,'0')}:${ss.toString().padStart(2,'0')}`; }
  function cardKV(t,v){ return `<div class="card"><div class="muted">${t}</div><div style="font-size:28px">${v}</div></div>`; }
  function emoGrid(avg){ return `<div class="kpis">${Object.entries(avg).map(([k,v])=>`<div class="card"><div class="muted">${k}</div><div style="font-size:22px">${(+v).toFixed(3)}</div></div>`).join('')}</div>`; }
  const valid=fr.filter(f=>f.face), facePct=((valid.length/Math.max(1,fr.length))*100).toFixed(1), ts=new Date(meta.ts).toLocaleString();
  const logo=segs.logo?.range?statsForRange(fr,segs.logo.range):null, cta=segs.cta?.range?statsForRange(fr,segs.cta.range):null, pack=segs.pack?.range?statsForRange(fr,segs.pack.range):null;
  return `<!doctype html><html><head><meta charset="utf-8"/><title>Emotion Ad Report</title>
  <style>body{font-family:system-ui,Arial;padding:24px;background:#0f1115;color:#e5e7eb}h1,h2{color:#fff}.kpis{display:flex;gap:12px;flex-wrap:wrap}.card{background:#121826;border:1px solid #1f2937;border-radius:12px;padding:12px;flex:1 1 220px}.muted{color:#9aa3b2}.row{display:flex;gap:12px;flex-wrap:wrap}img.asset{max-width:320px;border-radius:10px;border:1px solid #1f2937;background:#0b1020}</style></head><body>
  <h1>Emotion-Only Ad Report</h1><div class="muted">Generated: ${ts}</div><p class="muted">Ad: <code>${meta.ad||''}</code></p>
  <div class="kpis">${cardKV('Purchase Intention',kpi.PI)}${cardKV('Brand Perception',kpi.BP)}${cardKV('Awareness',kpi.AWR)}${cardKV('Face-tracked frames',`${valid.length} / ${fr.length} (${facePct}%)`)}</div>
  <h2>Emotion Averages (Whole Ad)</h2>${emoGrid(Object.fromEntries(['happy','sad','angry','disgusted','fearful','surprised','neutral'].map(k=>[k,avg(valid.map(v=>+v[k]||0))])))} 
  ${(logo||cta||pack)?`<h2>Branded Moments</h2>`:''}
  ${logo?`<div class="card"><b>Brand Logo</b> <span class="muted">${fmtTs(segs.logo.range.start)}–${fmtTs(segs.logo.range.end)}</span>${segs.logo.img?`<div class="row"><img class="asset" src="${segs.logo.img}"/></div>`:''}<div class="kpis">${cardKV('PI',logo.PI)}${cardKV('BP',logo.BP)}${cardKV('AWR',logo.AWR)}${cardKV('Frames',logo.count)}</div>${emoGrid(logo.avgEmo)}</div>`:''}
  ${cta?`<div class="card" style="margin-top:12px"><b>CTA</b> <span class="muted">${fmtTs(segs.cta.range.start)}–${fmtTs(segs.cta.range.end)}</span>${segs.cta.img?`<div class="row"><img class="asset" src="${segs.cta.img}"/></div>`:''}<div class="kpis">${cardKV('PI',cta.PI)}${cardKV('BP',cta.BP)}${cardKV('AWR',cta.AWR)}${cardKV('Frames',cta.count)}</div>${emoGrid(cta.avgEmo)}</div>`:''}
  ${pack?`<div class="card" style="margin-top:12px"><b>Packshot</b> <span class="muted">${fmtTs(segs.pack.range.start)}–${fmtTs(segs.pack.range.end)}</span>${segs.pack.img?`<div class="row"><img class="asset" src="${segs.pack.img}"/></div>`:''}<div class="kpis">${cardKV('PI',pack.PI)}${cardKV('BP',pack.BP)}${cardKV('AWR',pack.AWR)}${cardKV('Frames',pack.count)}</div>${emoGrid(pack.avgEmo)}</div>`:''}
  <details><summary>Raw frames JSON</summary><pre>${JSON.stringify(fr, null, 2)}</pre></details></body></html>`;
}

/* ---------- UI: Play / Analyze / Exports ---------- */
$('btnAnalyzeOnly').addEventListener('click', ()=>{
  frames.length=0; faceFrames=0; pFacesEl.textContent='0'; pFramesEl.textContent='0'; lastFaceAt=nowMs();
  if(!timer) timer=setInterval(tick, SAMPLE_MS);
  log('Analyzing webcam…');
});

$('btnPlay').addEventListener('click', async ()=>{
  frames.length=0; faceFrames=0; pFacesEl.textContent='0'; pFramesEl.textContent='0'; lastFaceAt=nowMs();
  ad.src = ($('adUrl').value||'').trim() || 'ads/0813.mp4';
  try{ await ad.play(); }catch{ ad.muted=true; await ad.play().catch(()=>{ log('Click the video to start, then click Play & analyze again.'); return; }); }
  if(!timer) timer=setInterval(tick, SAMPLE_MS);
  log('Analyzing…');
});

ad.addEventListener('ended', ()=>{
  if(timer){ clearInterval(timer); timer=null; }
  const k=calcKPIs(); log(`Done. PI=${k.PI} BP=${k.BP} AWR=${k.AWR}`);
  $('btnCSV').disabled=false; $('btnJSON').disabled=false; $('btnReport').disabled=false;
});

$('btnCSV').addEventListener('click', ()=> download(`frames_${Date.now()}.csv`, framesCSV(frames), 'text/csv'));
$('btnJSON').addEventListener('click', ()=>{
  const k=calcKPIs(); download(`report_${Date.now()}.json`, JSON.stringify({meta:{ts:Date.now(),ad:$('adUrl').value}, kpi:k, frames}, null, 2), 'application/json');
});
$('btnReport').addEventListener('click', ()=>{
  const k=calcKPIs(); const segs={ logo:{range:parseRange(($('logoRange').value||'').trim()), img:($('logoImg').value||'').trim()}, cta:{range:parseRange(($('ctaRange').value||'').trim()), img:($('ctaImg').value||'').trim()}, pack:{range:parseRange(($('packRange').value||'').trim()), img:($('packImg').value||'').trim()} };
  const html=buildReportHTML({ts:Date.now(), ad:$('adUrl').value}, k, frames, segs);
  download(`emotion_report_${Date.now()}.html`, html, 'text/html');
});

/* ---------- Face-lock test must pass ---------- */
$('btnTest').addEventListener('click', async ()=>{
  if(!webcamReady || !modelsReady){ diag('Not ready: webcam/models'); return; }
  diag('Test detection…');
  const det=await detectOnce(cam);
  if(det){
    const e=det.expressions||{};
    diag(`Face OK score=${det.detection.score.toFixed(3)} | happy=${(e.happy||0).toFixed(3)} sad=${(e.sad||0).toFixed(3)} ang=${(e.angry||0).toFixed(3)} dis=${(e.disgusted||0).toFixed(3)} fear=${(e.fearful||0).toFixed(3)} surp=${(e.surprised||0).toFixed(3)} neut=${(e.neutral||0).toFixed(3)}`);
    testPassed=true; updateReady('[test pass]');
  }else{
    diag('NO FACE — brighten lighting, move closer, center face, try another browser (Chrome/Edge).');
    testPassed=false; updateReady('[test fail]');
  }
});

/* ---------- Boot ---------- */
(function(){
  diagEl.textContent='DIAG:\\nPage loaded. Booting…\\n';
  updateReady('[boot]');
})();
</script>
</body>
</html>
