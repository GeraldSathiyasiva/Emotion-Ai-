<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Emotion Ad — Simple Flow (Auto Models + 5s Test)</title>
<style>
  :root { color-scheme: dark; }
  body { font-family: system-ui, Arial, sans-serif; margin:16px; background:#0f1115; color:#fff; }
  .row{display:flex;flex-wrap:wrap;gap:12px;align-items:flex-start}
  .panel{flex:1 1 360px;border:1px solid #222;border-radius:10px;padding:12px;background:#131722}
  button{padding:10px 14px;border:0;border-radius:10px;background:#2a2f3d;color:#fff;cursor:pointer}
  button:disabled{opacity:.55;cursor:not-allowed}
  label{display:block;margin-top:8px;font-weight:600}
  input[type="text"]{width:100%;padding:8px 10px;border-radius:8px;border:1px solid #333;background:#161a26;color:#fff}
  video,canvas{width:100%;border-radius:10px;background:#000}
  .camWrap{position:relative}
  #overlay{position:absolute;inset:0;width:100%;height:100%;border-radius:10px;pointer-events:none}
  .pill{display:inline-block;padding:2px 8px;border-radius:8px;background:#1f2433;margin-left:8px;font:12px ui-monospace}
  #diag{white-space:pre-wrap;font:12px ui-monospace;max-height:240px;overflow:auto;background:#0b1020;border:1px solid #222;border-radius:8px;padding:8px;margin-top:10px}
  .kpi{display:flex;gap:10px;margin-top:10px}
  .kpi>div{flex:1 1 0;background:#101520;border:1px solid #222;border-radius:10px;padding:10px;text-align:center}
  .warn{background:#3b0d0d;color:#ffdada;border:1px solid #5c1212;border-radius:8px;padding:8px 12px;margin-bottom:10px;display:none}
</style>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.18.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
</head>
<body>
<div id="httpsWarn" class="warn">Use <b>HTTPS</b> or <b>localhost</b>. Camera may fail on <code>file://</code> or plain <code>http://</code>.</div>

<h2>Emotion-Only Ad Test
  <span class="pill">frames: <span id="pFrames">0</span></span>
  <span class="pill">faces: <span id="pFaces">0</span></span>
</h2>

<div class="row">
  <div class="panel" style="flex:1 1 620px;">
    <label>Ad URL (MP4)</label>
    <input id="adUrl" type="text" value="ads/0813.mp4" />

    <div class="row" style="margin-top:10px;">
      <div style="flex:1 1 420px;min-width:300px">
        <video id="ad" controls playsinline></video>
      </div>
      <div class="camWrap" style="flex:1 1 260px;min-width:240px">
        <video id="cam" autoplay muted playsinline></video>
        <canvas id="overlay"></canvas>
      </div>
    </div>

    <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
      <button id="btnCam">Start webcam</button>
      <button id="btnTest" disabled>Test 5s</button>
      <button id="btnPlay" disabled>Play & analyze</button>
      <button id="btnCSV" disabled>Download CSV</button>
      <button id="btnJSON" disabled>Download JSON</button>
      <button id="btnReport" disabled>Generate Report</button>
      <span id="status" style="align-self:center;color:#9aa3b2">Booting…</span>
    </div>

    <div class="kpi">
      <div><div style="color:#9aa3b2">Purchase Intention</div><div id="pi">—</div></div>
      <div><div style="color:#9aa3b2">Brand Perception</div><div id="bp">—</div></div>
      <div><div style="color:#9aa3b2">Awareness</div><div id="awr">—</div></div>
    </div>

    <div id="diag">DIAG:\n</div>
  </div>

  <div class="panel" style="flex:1 1 380px;">
    <b>Branded Moments (optional)</b>
    <label>Logo (mm:ss-mm:ss)</label><input id="logoRange" type="text" placeholder="00:02-00:04" />
    <label>CTA (mm:ss-mm:ss)</label><input id="ctaRange" type="text" placeholder="00:04-00:06" />
    <label>Packshot (mm:ss-mm:ss)</label><input id="packRange" type="text" placeholder="00:06-00:07" />
  </div>
</div>

<div id="diag"></div>

<script>
/* ===== Basics ===== */
const MODEL_URL = '/models';               // auto-load from backend path — no user input
const TEST_SECONDS = 5;
const SAMPLE_MS = 200;

const $ = id => document.getElementById(id);
const ad=$('ad'), cam=$('cam'), canv=$('overlay'), ctx=canv.getContext('2d');
const statusEl=$('status'), diagEl=$('diag');
const piEl=$('pi'), bpEl=$('bp'), awrEl=$('awr');
const pFramesEl=$('pFrames'), pFacesEl=$('pFaces');

let webcamReady=false, modelsReady=false, testPassed=false;
let timer=null, frames=[], faceFrames=0;

/* ===== Utils ===== */
const log = (...a)=> statusEl.textContent = a.join(' ');
const diag = (...a)=>{ console.log('[diag]',...a); diagEl.textContent += a.join(' ') + '\\n'; diagEl.scrollTop = diagEl.scrollHeight; };
const clamp=(x,a,b)=>Math.min(b,Math.max(a,x));
function parseTime(t){ if(!t) return null; if(/^\\d+(\\.\\d+)?$/.test(t)) return parseFloat(t); const m=t.match(/^(\\d{1,2}):(\\d{2})(?:\\.(\\d+))?$/); if(!m) return null; const mm=+m[1], ss=+m[2], f=m[3]?parseFloat('0.'+m[3]):0; return mm*60+ss+f; }
function parseRange(r){ if(!r) return null; const m=r.split('-'); if(m.length!==2) return null; const s=parseTime(m[0].trim()), e=parseTime(m[1].trim()); if(isNaN(s)||isNaN(e)||e<=s) return null; return {start:s,end:e}; }

/* ===== Security hint ===== */
(function(){
  const ok = (location.protocol==='https:' || location.hostname==='localhost');
  if(!ok) $('httpsWarn').style.display='block';
})();

/* ===== Webcam ===== */
$('btnCam').addEventListener('click', startWebcam);

async function startWebcam(){
  try{
    diag('Requesting webcam…');
    const st = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'user', width:{ideal:1280}, height:{ideal:720} }, audio:false });
    cam.srcObject = st; await cam.play(); await new Promise(r=>cam.onloadedmetadata=r);
    canv.width = cam.videoWidth || 640; canv.height = cam.videoHeight || 480;
    webcamReady = true; log(`Webcam ready ${canv.width}x${canv.height}`);
    diag('Auto-loading models from', MODEL_URL, '…');   // AUTO LOAD MODELS HERE
    await loadModels();
    $('btnTest').disabled = false;                      // allow Test 5s now
  }catch(e){
    diag('Webcam ERROR:', e?.message||e); alert('Camera error: '+(e?.message||e));
  }
}

/* ===== Models (auto) ===== */
async function loadModels(){
  try{
    // quick probe to fail fast
    const testUrl = `${MODEL_URL}/tiny_face_detector_model-weights_manifest.json?cb=${Date.now()}`;
    const probe = await fetch(testUrl, {cache:'no-store'});
    if(!probe.ok) throw new Error(`Models not found at ${MODEL_URL}`);
    if (faceapi?.tf?.setBackend){ try{ await faceapi.tf.setBackend('webgl'); await faceapi.tf.ready(); diag('TFJS backend: webgl'); }catch(e){ diag('TFJS backend set failed:', e?.message||e); } }
    await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
    await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
    await faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL);
    modelsReady = true; diag('MODELS: OK ✔ tinyFace + landmarks68 + expressions');
  }catch(e){
    modelsReady = false; diag('Model load ERROR:', e?.message||e);
    alert('Model load error: '+(e?.message||e)+'\nPlace the face-api models under '+MODEL_URL);
  }
}

/* ===== Detection ===== */
async function detectOnce(videoEl){
  const tries = [
    { inputSize: 512, scoreThreshold: 0.06 },
    { inputSize: 384, scoreThreshold: 0.06 },
    { inputSize: 320, scoreThreshold: 0.05 }
  ];
  for (const opt of tries){
    const res = await faceapi
      .detectAllFaces(videoEl, new faceapi.TinyFaceDetectorOptions(opt))
      .withFaceLandmarks().withFaceExpressions();
    if (res && res.length){
      return res.reduce((b,c)=> c.detection.score > (b?.detection.score||0) ? c : b, null);
    }
  }
  return null;
}

/* ===== 5s TEST ===== */
$('btnTest').addEventListener('click', async ()=>{
  if(!webcamReady || !modelsReady){ diag('Not ready for test.'); return; }
  diag('TEST: Starting 5s detection… keep your face centered & lit.');
  const testFrames=[]; let testFace=0; const start = performance.now();

  // run loop for TEST_SECONDS
  while (performance.now() - start < TEST_SECONDS*1000){
    ctx.clearRect(0,0,canv.width,canv.height);
    if (cam.readyState >= 2) ctx.drawImage(cam,0,0,canv.width,canv.height);
    const det = await detectOnce(cam);
    if(det){
      const r = faceapi.resizeResults(det, { width: canv.width, height: canv.height });
      faceapi.draw.drawDetections(canv, r);
      faceapi.draw.drawFaceLandmarks(canv, r);
      const e = det.expressions || {};
      testFrames.push(e); testFace++;
    }else{
      testFrames.push(null);
    }
    await new Promise(r=>setTimeout(r,SAMPLE_MS));
  }

  // summarize
  const faced = testFrames.filter(x=>!!x);
  const avg = k => faced.length ? faced.reduce((s,v)=>s+(+v[k]||0),0)/faced.length : 0;
  diag(
    `TEST RESULT — frames=${testFrames.length}, faceFrames=${faced.length}`,
    `avg(happy)=${avg('happy').toFixed(3)} sad=${avg('sad').toFixed(3)} angry=${avg('angry').toFixed(3)} disgusted=${avg('disgusted').toFixed(3)} fearful=${avg('fearful').toFixed(3)} surprised=${avg('surprised').toFixed(3)} neutral=${avg('neutral').toFixed(3)}`
  );

  // gate Play until at least some faces were seen
  if (faced.length > 0){
    testPassed = true;
    $('btnPlay').disabled = false;
    diag('TEST: PASS → Play & analyze enabled.');
  }else{
    testPassed = false;
    $('btnPlay').disabled = true;
    diag('TEST: FAIL → No face seen. Improve lighting / move closer / center face and re-run test.');
  }
});

/* ===== Live sampling for the ad ===== */
function pushRow(t, e, seen){
  frames.push({
    t, happy:+(e?.happy||0), sad:+(e?.sad||0), angry:+(e?.angry||0),
    disgusted:+(e?.disgusted||0), fearful:+(e?.fearful||0),
    surprised:+(e?.surprised||0), neutral:+(e?.neutral||0), face:seen?1:0
  });
  pFramesEl.textContent=String(frames.length);
}

$('btnPlay').addEventListener('click', async ()=>{
  if(!testPassed){ diag('Play blocked: run Test 5s first.'); return; }
  frames.length=0; faceFrames=0; pFacesEl.textContent='0'; pFramesEl.textContent='0';
  ad.src = ($('adUrl').value||'').trim() || 'ads/0813.mp4';
  try{ await ad.play(); }catch(e){ ad.muted=true; try{ await ad.play(); }catch{ log('Click the video to start, then click Play & analyze again.'); return; } }
  if (timer) clearInterval(timer);
  timer = setInterval(async ()=>{
    ctx.clearRect(0,0,canv.width,canv.height);
    if (cam.readyState >= 2) ctx.drawImage(cam,0,0,canv.width,canv.height);
    const det = await detectOnce(cam);
    if(det){
      const r = faceapi.resizeResults(det, { width: canv.width, height: canv.height });
      faceapi.draw.drawDetections(canv, r);
      faceapi.draw.drawFaceLandmarks(canv, r);
      const e = det.expressions || {};
      faceFrames++; pFacesEl.textContent=String(faceFrames);
      pushRow(ad.currentTime||0, e, true);
    }else{
      pushRow(ad.currentTime||0, null, false);
    }
  }, SAMPLE_MS);
  log('Analyzing…');
});

ad.addEventListener('ended', ()=>{
  if (timer){ clearInterval(timer); timer=null; }
  const k = calcKPIs();
  log(`Done. PI=${k.PI} BP=${k.BP} AWR=${k.AWR}`);
  $('btnCSV').disabled=false; $('btnJSON').disabled=false; $('btnReport').disabled=false;
});

/* ===== KPIs + Exports + Report ===== */
function calcKPIs(){
  const valid = frames.filter(f=>f.face);
  const total = valid.length || 1;
  const posFrames = valid.filter(f => (f.happy>0.30) || (f.surprised>0.30)).length;
  const negFrames = valid.filter(f => (f.sad>0.30) || (f.angry>0.30) || (f.disgusted>0.30)).length;
  const awareFrames = valid.filter(f => (f.happy>0.15)||(f.sad>0.15)||(f.angry>0.15)||(f.surprised>0.15)||(f.fearful>0.15)).length;
  const PI  = clamp( (posFrames/total)*100, 0, 100 );
  const BP  = clamp( ((posFrames - negFrames)/total)*100 + 50, 0, 100 );
  const AWR = clamp( (awareFrames/total)*100, 0, 100 );
  piEl.textContent  = PI.toFixed(1);
  bpEl.textContent  = BP.toFixed(1);
  awrEl.textContent = AWR.toFixed(1);
  return { PI:+PI.toFixed(1), BP:+BP.toFixed(1), AWR:+AWR.toFixed(1) };
}

function download(name, text, type='text/plain'){
  const blob = new Blob([text], {type}); const a=document.createElement('a');
  a.href=URL.createObjectURL(blob); a.download=name; a.click(); URL.revokeObjectURL(a.href);
}
function framesCSV(rows){
  const header = ['t','happy','sad','angry','disgusted','fearful','surprised','neutral','face'];
  return [header.join(',')].concat(rows.map(r=>[r.t,r.happy,r.sad,r.angry,r.disgusted,r.fearful,r.surprised,r.neutral,r.face].map(x=>typeof x==='number'?x.toFixed(4):x).join(','))).join('\\n');
}
$('btnCSV').addEventListener('click', ()=> download(`frames_${Date.now()}.csv`, framesCSV(frames), 'text/csv'));
$('btnJSON').addEventListener('click', ()=>{
  const k = calcKPIs();
  download(`report_${Date.now()}.json`, JSON.stringify({ meta:{ ts:Date.now(), ad:$('adUrl').value }, kpi:k, frames }, null, 2), 'application/json');
});

/* Simple report (kept) */
function avg(a){ return a.length? a.reduce((x,y)=>x+y,0)/a.length : 0; }
function statsForRange(fr, range){
  if(!range) return null; const sub=fr.filter(f=>f.face && f.t>=range.start && f.t<=range.end);
  const ems=['happy','sad','angry','disgusted','fearful','surprised','neutral'];
  const avgEmo=Object.fromEntries(ems.map(k=>[k, avg(sub.map(v=>+v[k]||0))]));
  const total=sub.length||1, pos=sub.filter(f=>(f.happy>0.30)||(f.surprised>0.30)).length, neg=sub.filter(f=>(f.sad>0.30)||(f.angry>0.30)||(f.disgusted>0.30)).length, aware=sub.filter(f=>(f.happy>0.15)||(f.sad>0.15)||(f.angry>0.15)||(f.surprised>0.15)||(f.fearful>0.15)).length;
  return { count: sub.length, avgEmo, PI:+((pos/total)*100).toFixed(1), BP:+(((pos-neg)/total)*100+50).toFixed(1), AWR:+((aware/total)*100).toFixed(1) };
}
$('btnReport').addEventListener('click', ()=>{
  const k = calcKPIs();
  const segments = {
    logo: { range: parseRange(($('logoRange').value||'').trim()) },
    cta:  { range: parseRange(($('ctaRange').value||'').trim())  },
    pack: { range: parseRange(($('packRange').value||'').trim()) }
  };
  const html = buildReportHTML({ ts:Date.now(), ad:$('adUrl').value }, k, frames, segments);
  download(`emotion_report_${Date.now()}.html`, html, 'text/html');
});

function buildReportHTML(meta, kpi, fr, segs){
  function fmtTs(s){ const mm=Math.floor(s/60), ss=Math.floor(s%60); return `${mm.toString().padStart(2,'0')}:${ss.toString().padStart(2,'0')}`; }
  function cardKV(t,v){ return `<div class="card"><div class="muted">${t}</div><div style="font-size:28px">${v}</div></div>`; }
  function emoGrid(avg){ return `<div class="kpis">${Object.entries(avg).map(([k,v])=>`<div class="card"><div class="muted">${k}</div><div style="font-size:22px">${(+v).toFixed(3)}</div></div>`).join('')}</div>`; }
  const valid=fr.filter(f=>f.face), facePct=((valid.length/Math.max(1,fr.length))*100).toFixed(1), ts=new Date(meta.ts).toLocaleString();
  const logo=segs.logo?.range?statsForRange(fr,segs.logo.range):null, cta=segs.cta?.range?statsForRange(fr,segs.cta.range):null, pack=segs.pack?.range?statsForRange(fr,segs.pack.range):null;
  return `<!doctype html><html><head><meta charset="utf-8"/><title>Emotion Ad Report</title>
  <style>body{font-family:system-ui,Arial;padding:24px;background:#0f1115;color:#e5e7eb}h1,h2{color:#fff}.kpis{display:flex;gap:12px;flex-wrap:wrap}.card{background:#121826;border:1px solid #1f2937;border-radius:12px;padding:12px;flex:1 1 220px}.muted{color:#9aa3b2}.row{display:flex;gap:12px;flex-wrap:wrap}</style></head><body>
  <h1>Emotion-Only Ad Report</h1><div class="muted">Generated: ${ts}</div><p class="muted">Ad: <code>${meta.ad||''}</code></p>
  <div class="kpis">${cardKV('Purchase Intention',kpi.PI)}${cardKV('Brand Perception',kpi.BP)}${cardKV('Awareness',kpi.AWR)}${cardKV('Face-tracked frames',`${valid.length} / ${fr.length} (${facePct}%)`)}</div>
  <h2>Emotion Averages (Whole Ad)</h2>${emoGrid(Object.fromEntries(['happy','sad','angry','disgusted','fearful','surprised','neutral'].map(k=>[k,avg(valid.map(v=>+v[k]||0))])))} 
  ${logo?`<h2>Brand Logo ${fmtTs(segs.logo.range.start)}–${fmtTs(segs.logo.range.end)}</h2>${emoGrid(logo.avgEmo)}<div class="kpis">${cardKV('PI',logo.PI)}${cardKV('BP',logo.BP)}${cardKV('AWR',logo.AWR)}${cardKV('Frames',logo.count)}</div>`:''}
  ${cta?`<h2>CTA ${fmtTs(segs.cta.range.start)}–${fmtTs(segs.cta.range.end)}</h2>${emoGrid(cta.avgEmo)}<div class="kpis">${cardKV('PI',cta.PI)}${cardKV('BP',cta.BP)}${cardKV('AWR',cta.AWR)}${cardKV('Frames',cta.count)}</div>`:''}
  ${pack?`<h2>Packshot ${fmtTs(segs.pack.range.start)}–${fmtTs(segs.pack.range.end)}</h2>${emoGrid(pack.avgEmo)}<div class="kpis">${cardKV('PI',pack.PI)}${cardKV('BP',pack.BP)}${cardKV('AWR',pack.AWR)}${cardKV('Frames',pack.count)}</div>`:''}
  <details><summary>Raw frames JSON</summary><pre>${JSON.stringify(fr,null,2)}</pre></details></body></html>`;
}

/* ===== Boot ===== */
diagEl.textContent = 'DIAG:\\nPage loaded. Booting…\\n';
if (location.protocol!=='https:' && location.hostname!=='localhost'){ $('httpsWarn').style.display='block'; }
</script>
</body>
</html>
