<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Camera Sanity Check</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body{background:#0f1115;color:#e5e7eb;font-family:system-ui,Arial;margin:16px}
  video{width:640px;max-width:100%;border:1px solid #2a2f3d;border-radius:10px;background:#000}
  #diag{white-space:pre-wrap;font:12px ui-monospace;background:#0b1020;border:1px solid #222;border-radius:10px;padding:10px;height:260px;overflow:auto;margin-top:10px}
  button{padding:10px 14px;border:0;border-radius:10px;background:#2a2f3d;color:#fff;cursor:pointer}
</style>
</head>
<body>
<h2>Camera Sanity Check</h2>
<p>Click the button. If nothing appears, check the DIAG logs below — they’ll tell you exactly why.</p>
<div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
  <button id="btn">Start camera</button>
  <label><input id="rear" type="checkbox"> Use rear camera</label>
</div>
<video id="cam" autoplay playsinline muted></video>
<div id="diag">DIAG:\n</div>

<script>
const cam = document.getElementById('cam');
const diagEl = document.getElementById('diag');
const log = (...a)=>{ console.log('[diag]',...a); diagEl.textContent += a.join(' ') + '\n'; diagEl.scrollTop = diagEl.scrollHeight; };

window.addEventListener('error', e => log(`JS ERROR: ${e.message} @ ${e.filename}:${e.lineno}`));
window.addEventListener('unhandledrejection', e => log(`Promise REJECTION: ${e.reason?.message||e.reason}`));

(async ()=>{
  log('ENV secure/localhost:', (location.protocol==='https:' || location.hostname==='localhost'));
  log('Navigator:', navigator.userAgent);
  // Permission probe (best-effort; not supported everywhere)
  try{
    if (navigator.permissions?.query){
      const perm = await navigator.permissions.query({ name: 'camera' });
      log('Permission (camera):', perm.state);
      perm.onchange = () => log('Permission changed →', perm.state);
    }else{
      log('Permissions API not available');
    }
  }catch(e){ log('Permissions probe error:', e.message); }
})();

document.getElementById('btn').addEventListener('click', async ()=>{
  // prevent double clicks
  const btn = document.getElementById('btn');
  btn.disabled = true;
  try{
    // enumerate devices first (helps spot “no camera” situations)
    try{
      const devices = await navigator.mediaDevices.enumerateDevices();
      const cams = devices.filter(d=>d.kind==='videoinput');
      log('Devices video inputs:', cams.length);
      cams.forEach((d,i)=>log(`  [${i}]`, d.label || '(no label)', d.deviceId ? 'deviceId present' : 'no id'));
    }catch(e){ log('enumerateDevices error:', e.message); }

    const useRear = document.getElementById('rear').checked;
    // Two-step constraint strategy: try ideal HD with facingMode, then fall back to {video:true}
    const constraintsList = [
      { video: { facingMode: useRear ? 'environment' : 'user', width:{ideal:1280}, height:{ideal:720} }, audio:false },
      { video: { facingMode: useRear ? 'environment' : 'user' }, audio:false },
      { video: true, audio:false },
    ];

    let stream = null;
    let lastErr = null;
    for (const c of constraintsList){
      try{
        log('getUserMedia attempt:', JSON.stringify(c));
        stream = await navigator.mediaDevices.getUserMedia(c);
        break;
      }catch(err){
        lastErr = err;
        log('getUserMedia FAILED:', err.name, '-', err.message);
        // detail overconstrained
        if (err.name === 'OverconstrainedError' && err.constraint) {
          log('Overconstrained constraint:', err.constraint);
        }
      }
    }
    if (!stream) {
      log('FATAL: No stream obtained. Common causes:');
      log('- Permission denied (check the lock icon → Site settings → Camera → Allow)');
      log('- In-app browser blocking camera (open in Chrome/Edge/Safari proper)');
      log('- Another app using camera');
      log('- Enterprise/MDM policy or extension blocking getUserMedia');
      throw lastErr || new Error('getUserMedia failed for all constraints');
    }

    cam.srcObject = stream;
    // iOS/Safari quirks
    cam.setAttribute('playsinline','');
    cam.setAttribute('muted','');
    try { await cam.play(); } catch(e){ log('video.play() error:', e.name, e.message); }

    // Log actual video size
    await new Promise(r => requestAnimationFrame(r));
    log('Camera stream active:', cam.videoWidth, 'x', cam.videoHeight);

  }catch(e){
    log('Start flow error:', e?.name || 'Error', '-', e?.message || e);
    // surface actionable hints by error type
    if (e && e.name === 'NotAllowedError') {
      log('HINT: Permission denied. Click the lock icon in the address bar → Site settings → Allow Camera, then reload.');
    } else if (e && e.name === 'NotFoundError') {
      log('HINT: No camera found. Ensure a webcam is connected and not in use by another app.');
    } else if (e && e.name === 'NotReadableError') {
      log('HINT: Camera is busy (in use by another app). Close video apps (Zoom/Meet/Teams) and retry.');
    } else if (e && e.name === 'SecurityError') {
      log('HINT: Must use HTTPS or localhost. In-app browsers may also block camera.');
    }
  } finally {
    btn.disabled = false;
  }
});
</script>
</body>
</html>
