<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Emotion Ad — GitHub Models + 5s Test (Robust)</title>
<style>
  :root { color-scheme: dark; }
  body { font-family: system-ui, Arial, sans-serif; margin:16px; background:#0f1115; color:#e5e7eb; }
  .row{display:flex;flex-wrap:wrap;gap:12px;align-items:flex-start}
  .panel{flex:1 1 360px;border:1px solid #222;border-radius:10px;padding:12px;background:#131722}
  button{padding:10px 14px;border:0;border-radius:10px;background:#2a2f3d;color:#fff;cursor:pointer}
  button:disabled{opacity:.55;cursor:not-allowed}
  label{display:block;margin-top:8px;font-weight:600}
  input[type="text"]{width:100%;padding:8px 10px;border-radius:8px;border:1px solid #333;background:#161a26;color:#fff}
  video,canvas{width:100%;border-radius:10px;background:#000}
  .camWrap{position:relative}
  #overlay{position:absolute;inset:0;width:100%;height:100%;border-radius:10px;pointer-events:none}
  .pill{display:inline-block;padding:2px 8px;border-radius:8px;background:#1f2433;margin-left:8px;font:12px ui-monospace}
  #diag{white-space:pre-wrap;font:12px ui-monospace;max-height:260px;overflow:auto;background:#0b1020;border:1px solid #222;border-radius:8px;padding:8px;margin-top:10px}
  .kpi{display:flex;gap:10px;margin-top:10px}
  .kpi>div{flex:1 1 0;background:#101520;border:1px solid #222;border-radius:10px;padding:10px;text-align:center}
  .warn{background:#3b0d0d;color:#ffdada;border:1px solid #5c1212;border-radius:8px;padding:8px 12px;margin-bottom:10px;display:none}
  .row.controls {display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .row.controls label { font-weight:500; margin:0 }
</style>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.18.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
</head>
<body>
<div id="httpsWarn" class="warn">Use <b>HTTPS</b> or <b>localhost</b>. Camera will fail on <code>file://</code> or plain <code>http://</code>.</div>

<h2>Emotion-Only Ad Test
  <span class="pill">frames: <span id="pFrames">0</span></span>
  <span class="pill">faces: <span id="pFaces">0</span></span>
</h2>

<div class="row">
  <div class="panel" style="flex:1 1 620px;">
    <label>Ad URL (MP4)</label>
    <input id="adUrl" type="text" value="ads/0813.mp4" />

    <div class="row" style="margin-top:10px;">
      <div style="flex:1 1 420px;min-width:300px">
        <video id="ad" controls playsinline></video>
      </div>
      <div class="camWrap" style="flex:1 1 260px;min-width:240px">
        <video id="cam" autoplay muted playsinline></video>
        <canvas id="overlay"></canvas>
      </div>
    </div>

    <div class="row controls" style="margin-top:10px">
      <button id="btnCam">Start webcam</button>
      <button id="btnTest" disabled>Test 5s</button>
      <button id="btnPlay" disabled>Play & analyze</button>
      <button id="btnCSV" disabled>Download CSV</button>
      <button id="btnJSON" disabled>Download JSON</button>
      <button id="btnReport" disabled>Generate Report</button>
      <label><input id="flip" type="checkbox" checked /> Mirror</label>
      <label><input id="rear" type="checkbox" /> Rear camera</label>
      <span id="status" style="color:#9aa3b2">Booting…</span>
    </div>

    <div class="kpi">
      <div><div style="color:#9aa3b2">Purchase Intention</div><div id="pi">—</div></div>
      <div><div style="color:#9aa3b2">Brand Perception</div><div id="bp">—</div></div>
      <div><div style="color:#9aa3b2">Awareness</div><div id="awr">—</div></div>
    </div>

    <div id="diag">DIAG:\n</div>
  </div>

  <div class="panel" style="flex:1 1 380px;">
    <b>Branded Moments (optional)</b>
    <label>Logo (mm:ss-mm:ss)</label><input id="logoRange" type="text" placeholder="00:02-00:04" />
    <label>CTA (mm:ss-mm:ss)</label><input id="ctaRange" type="text" placeholder="00:04-00:06" />
    <label>Packshot (mm:ss-mm:ss)</label><input id="packRange" type="text" placeholder="00:06-00:07" />
  </div>
</div>

<script>
/* ===== Constants ===== */
const GH_PAGES_BASE = 'https://geraldsathiyasiva.github.io/Emotion-Ai-/models';
const GH_RAW_BASE   = 'https://raw.githubusercontent.com/GeraldSathiyasiva/Emotion-Ai-/main/models';
const TEST_SECONDS = 5;
const SAMPLE_MS = 200;

/* ===== DOM / State ===== */
const $=id=>document.getElementById(id);
const ad=$('ad'), cam=$('cam'), canv=$('overlay'), ctx=canv.getContext('2d',{willReadFrequently:true});
const statusEl=$('status'), diagEl=$('diag');
const pFramesEl=$('pFrames'), pFacesEl=$('pFaces');
const piEl=$('pi'), bpEl=$('bp'), awrEl=$('awr');
let MODEL_URL=null;
let webcamReady=false, modelsReady=false, testPassed=false;
let timer=null, frames=[], faceFrames=0;
let lastStream=null;

/* ===== Utils ===== */
const log=(...a)=>statusEl.textContent=a.join(' ');
const diag=(...a)=>{ console.log('[diag]',...a); diagEl.textContent+=a.join(' ')+'\\n'; diagEl.scrollTop=diagEl.scrollHeight; };
const clamp=(x,a,b)=>Math.min(b,Math.max(a,x));
function parseTime(t){ if(!t) return null; if(/^\\d+(\\.\\d+)?$/.test(t)) return parseFloat(t); const m=t.match(/^(\\d{1,2}):(\\d{2})(?:\\.(\\d+))?$/); if(!m) return null; const mm=+m[1], ss=+m[2], f=m[3]?parseFloat('0.'+m[3]):0; return mm*60+ss+f; }
function parseRange(r){ if(!r) return null; const m=r.split('-'); if(m.length!==2) return null; const s=parseTime(m[0].trim()), e=parseTime(m[1].trim()); if(isNaN(s)||isNaN(e)||e<=s) return null; return {start:s,end:e}; }

/* ===== Security hint ===== */
(function(){
  const ok = (location.protocol==='https:' || location.hostname==='localhost');
  if(!ok) document.getElementById('httpsWarn').style.display='block';
})();

/* ===== Model host auto-detect (Pages → Raw) ===== */
async function pickModelBase(){
  const probe = async (base) => {
    const u = `${base}/tiny_face_detector_model-weights_manifest.json?cb=${Date.now()}`;
    try{
      const r = await fetch(u, {cache:'no-store'});
      diag('PROBE', u, '→', r.status);
      if(r.ok) return base;
    }catch(e){ diag('PROBE ERR', base, e?.message||e); }
    return null;
  };
  return await probe(GH_PAGES_BASE) || await probe(GH_RAW_BASE);
}

/* ===== Webcam ===== */
$('btnCam').addEventListener('click', ()=>startWebcam($('rear').checked));
$('rear').addEventListener('change', e=>{
  if(lastStream){ lastStream.getTracks().forEach(t=>t.stop()); }
  startWebcam(e.target.checked);
});

async function startWebcam(useRear=false){
  try{
    diag('Requesting webcam… facing=', useRear?'environment':'user');
    const st = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode: useRear?'environment':'user', width:{ideal:1280}, height:{ideal:720} },
      audio:false
    });
    lastStream = st;
    cam.srcObject = st; await cam.play(); await new Promise(r=>cam.onloadedmetadata=r);
    canv.width = cam.videoWidth || 640; canv.height = cam.videoHeight || 480;
    webcamReady=true; log(`Webcam ${cam.videoWidth}x${cam.videoHeight}`);
    diag('Video size:', cam.videoWidth, 'x', cam.videoHeight);

    MODEL_URL = await pickModelBase();
    if(!MODEL_URL){ diag('FATAL: Could not find models on GitHub.'); alert('Models not reachable from Pages or Raw.'); return; }
    diag('MODEL_URL =', MODEL_URL);
    await loadModels(MODEL_URL);
    $('btnTest').disabled = false;
  }catch(e){
    diag('Webcam ERROR:', e?.message||e); alert('Camera error: '+(e?.message||e));
  }
}

/* ===== Models ===== */
async function loadModels(base){
  try{
    if (faceapi?.tf?.setBackend){
      try{ await faceapi.tf.setBackend('webgl'); await faceapi.tf.ready(); diag('TFJS backend:', faceapi.tf.getBackend()); }
      catch(e){ diag('TFJS backend set failed:', e?.message||e); }
    } else {
      diag('TFJS backend API unavailable');
    }
    diag('Loading models from', base, '…');
    await faceapi.nets.tinyFaceDetector.loadFromUri(base);
    await faceapi.nets.faceLandmark68Net.loadFromUri(base);
    await faceapi.nets.faceExpressionNet.loadFromUri(base);
    modelsReady = true; diag('MODELS: OK ✔ tinyFace + landmarks68 + expressions');
  }catch(e){
    modelsReady = false; diag('Model load ERROR:', e?.message||e);
    alert('Model load error: '+(e?.message||e));
  }
}

/* ===== Brightness check (center 64×64) ===== */
function luminanceSample(){
  const w=canv.width, h=canv.height;
  if(!w||!h) return 0;
  const cx=Math.floor(w/2)-32, cy=Math.floor(h/2)-32;
  const img=ctx.getImageData(Math.max(0,cx), Math.max(0,cy), 64, 64).data;
  let sum=0, n=0;
  for(let i=0;i<img.length;i+=4){ const r=img[i], g=img[i+1], b=img[i+2]; sum += 0.2126*r+0.7152*g+0.0722*b; n++; }
  return n? (sum/n) : 0;
}

/* ===== Detection (aggressive sweep) ===== */
async function detectOnce(videoEl){
  const tries = [
    { inputSize: 640, scoreThreshold: 0.025 },
    { inputSize: 576, scoreThreshold: 0.025 },
    { inputSize: 512, scoreThreshold: 0.025 },
    { inputSize: 448, scoreThreshold: 0.025 },
    { inputSize: 384, scoreThreshold: 0.030 },
    { inputSize: 320, scoreThreshold: 0.035 },
  ];
  for (const opt of tries){
    const res = await faceapi
      .detectAllFaces(videoEl, new faceapi.TinyFaceDetectorOptions(opt))
      .withFaceLandmarks().withFaceExpressions();
    if (res && res.length){
      return res.reduce((b,c)=> c.detection.score > (b?.detection.score||0) ? c : b, null);
    }
  }
  return null;
}

/* ===== 5s TEST ===== */
$('btnTest').addEventListener('click', async ()=>{
  if(!webcamReady || !modelsReady){ diag('TEST blocked: webcam/models not ready'); return; }
  diag('TEST: 5s — keep face centered. If no detections, watch DIAG for brightness & scores.');
  const facedExpr = []; let detectedFrames=0;
  const start = performance.now();

  while (performance.now() - start < TEST_SECONDS*1000){
    // draw
    ctx.save();
    ctx.clearRect(0,0,canv.width,canv.height);
    if ($('flip').checked){
      ctx.translate(canv.width,0); ctx.scale(-1,1);
    }
    ctx.drawImage(cam,0,0,canv.width,canv.height);
    ctx.restore();

    const Y = luminanceSample().toFixed(1);
    if (Y < 35) diag(`Too dark? center luminance=${Y} (aim > 50)`);

    const det = await detectOnce(cam);
    if(det){
      const r = faceapi.resizeResults(det, { width: canv.width, height: canv.height });
      faceapi.draw.drawDetections(canv, r);
      faceapi.draw.drawFaceLandmarks(canv, r);
      facedExpr.push(det.expressions||{});
      detectedFrames++;
      diag(`✓ face score=${det.detection.score.toFixed(3)} size=${Math.round(det.detection.box.width)}x${Math.round(det.detection.box.height)} lum=${Y}`);
    }else{
      diag(`× no face (lum=${Y})`);
    }
    await new Promise(r=>setTimeout(r,SAMPLE_MS));
  }

  // summary
  const avg = k => facedExpr.length ? facedExpr.reduce((s,v)=>s+(+v[k]||0),0)/facedExpr.length : 0;
  diag(`TEST RESULT — detectedFrames=${detectedFrames}/${Math.ceil(TEST_SECONDS*1000/SAMPLE_MS)}  avg(happy)=${avg('happy').toFixed(3)} sad=${avg('sad').toFixed(3)} angry=${avg('angry').toFixed(3)} disgusted=${avg('disgusted').toFixed(3)} fearful=${avg('fearful').toFixed(3)} surprised=${avg('surprised').toFixed(3)} neutral=${avg('neutral').toFixed(3)}`);

  if (detectedFrames>0){
    testPassed = true; $('btnPlay').disabled = false; diag('TEST: PASS → Play & analyze enabled.');
  }else{
    testPassed = false; $('btnPlay').disabled = true;
    diag('TEST: FAIL → Try: more front light; move closer (face ~25% of frame); uncheck Mirror; toggle Rear camera; try Chrome/Edge desktop; confirm manifest URL loads in browser.');
    diag('Check URL now:', `${MODEL_URL}/tiny_face_detector_model-weights_manifest.json`);
  }
});

/* ===== Live sampling for the ad ===== */
function pushRow(t, e, seen){
  frames.push({
    t, happy:+(e?.happy||0), sad:+(e?.sad||0), angry:+(e?.angry||0),
    disgusted:+(e?.disgusted||0), fearful:+(e?.fearful||0),
    surprised:+(e?.surprised||0), neutral:+(e?.neutral||0), face:seen?1:0
  });
  pFramesEl.textContent=String(frames.length);
}

$('btnPlay').addEventListener('click', async ()=>{
  if(!testPassed){ diag('Play blocked: run Test 5s first.'); return; }
  frames.length=0; faceFrames=0; pFacesEl.textContent='0'; pFramesEl.textContent='0';
  ad.src = ($('adUrl').value||'').trim() || 'ads/0813.mp4';
  try{ await ad.play(); }catch(e){ ad.muted=true; try{ await ad.play(); }catch{ log('Click the video to start, then click Play & analyze again.'); return; } }
  if (timer) clearInterval(timer);
  timer = setInterval(async ()=>{
    ctx.save();
    ctx.clearRect(0,0,canv.width,canv.height);
    if ($('flip').checked){ ctx.translate(canv.width,0); ctx.scale(-1,1); }
    ctx.drawImage(cam,0,0,canv.width,canv.height);
    ctx.restore();

    const det = await detectOnce(cam);
    if(det){
      const r = faceapi.resizeResults(det, { width: canv.width, height: canv.height });
      faceapi.draw.drawDetections(canv, r);
      faceapi.draw.drawFaceLandmarks(canv, r);
      const e = det.expressions || {};
      faceFrames++; pFacesEl.textContent=String(faceFrames);
      pushRow(ad.currentTime||0, e, true);
    }else{
      pushRow(ad.currentTime||0, null, false);
    }
  }, SAMPLE_MS);
  log('Analyzing…');
});

ad.addEventListener('ended', ()=>{
  if (timer){ clearInterval(timer); timer=null; }
  const k = calcKPIs();
  log(`Done. PI=${k.PI} BP=${k.BP} AWR=${k.AWR}`);
  $('btnCSV').disabled=false; $('btnJSON').disabled=false; $('btnReport').disabled=false;
});

/* ===== KPIs + Exports + Report (unchanged essentials) ===== */
function calcKPIs(){
  const valid = frames.filter(f=>f.face);
  const total = valid.length || 1;
  const posFrames = valid.filter(f => (f.happy>0.30) || (f.surprised>0.30)).length;
  const negFrames = valid.filter(f => (f.sad>0.30) || (f.angry>0.30) || (f.disgusted>0.30)).length;
  const awareFrames = valid.filter(f => (f.happy>0.15)||(f.sad>0.15)||(f.angry>0.15)||(f.surprised>0.15)||(f.fearful>0.15)).length;
  const PI  = clamp( (posFrames/total)*100, 0, 100 );
  const BP  = clamp( ((posFrames - negFrames)/total)*100 + 50, 0, 100 );
  const AWR = clamp( (awareFrames/total)*100, 0, 100 );
  piEl.textContent  = PI.toFixed(1);
  bpEl.textContent  = BP.toFixed(1);
  awrEl.textContent = AWR.toFixed(1);
  return { PI:+PI.toFixed(1), BP:+BP.toFixed(1), AWR:+AWR.toFixed(1) };
}
function download(name, text, type='text/plain'){ const blob=new Blob([text],{type}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); URL.revokeObjectURL(a.href); }
function framesCSV(rows){ const header = ['t','happy','sad','angry','disgusted','fearful','surprised','neutral','face']; return [header.join(',')].concat(rows.map(r=>[r.t,r.happy,r.sad,r.angry,r.disgusted,r.fearful,r.surprised,r.neutral,r.face].map(x=>typeof x==='number'?x.toFixed(4):x).join(','))).join('\\n'); }
function avg(a){ return a.length? a.reduce((x,y)=>x+y,0)/a.length : 0; }
function statsForRange(fr, range){
  if(!range) return null; const sub=fr.filter(f=>f.face && f.t>=range.start && f.t<=range.end);
  const ems=['happy','sad','angry','disgusted','fearful','surprised','neutral'];
  const avgEmo=Object.fromEntries(ems.map(k=>[k, avg(sub.map(v=>+v[k]||0))]));
  const total=sub.length||1, pos=sub.filter(f=>(f.happy>0.30)||(f.surprised>0.30)).length, neg=sub.filter(f=>(f.sad>0.30)||(f.angry>0.30)||(f.disgusted>0.30)).length, aware=sub.filter(f=>(f.happy>0.15)||(f.sad>0.15)||(f.angry>0.15)||(f.surprised>0.15)||(f.fearful>0.15)).length;
  return { count: sub.length, avgEmo, PI:+((pos/total)*100).toFixed(1), BP:+(((pos-neg)/total)*100+50).toFixed(1), AWR:+((aware/total)*100).toFixed(1) };
}
function buildReportHTML(meta, kpi, fr, segs){
  function fmtTs(s){ const mm=Math.floor(s/60), ss=Math.floor(s%60); return `${mm.toString().padStart(2,'0')}:${ss.toString().padStart(2,'0')}`; }
  function cardKV(t,v){ return `<div class="card"><div class="muted">${t}</div><div style="font-size:28px">${v}</div></div>`; }
  function emoGrid(avg){ return `<div class="kpis">${Object.entries(avg).map(([k,v])=>`<div class="card"><div class="muted">${k}</div><div style="font-size:22px">${(+v).toFixed(3)}</div></div>`).join('')}</div>`; }
  const valid=fr.filter(f=>f.face), facePct=((valid.length/Math.max(1,fr.length))*100).toFixed(1), ts=new Date(meta.ts||Date.now()).toLocaleString();
  const logo=segs.logo?.range?statsForRange(fr,segs.logo.range):null, cta=segs.cta?.range?statsForRange(fr,segs.cta.range):null, pack=segs.pack?.range?statsForRange(fr,segs.pack.range):null;
  return `<!doctype html><html><head><meta charset="utf-8"/><title>Emotion Ad Report</title>
  <style>body{font-family:system-ui,Arial;padding:24px;background:#0f1115;color:#e5e7eb}h1,h2{color:#fff}.kpis{display:flex;gap:12px;flex-wrap:wrap}.card{background:#121826;border:1px solid #1f2937;border-radius:12px;padding:12px;flex:1 1 220px}.muted{color:#9aa3b2}.row{display:flex;gap:12px;flex-wrap:wrap}</style></head><body>
  <h1>Emotion-Only Ad Report</h1><div class="muted">Generated: ${ts}</div><p class="muted">Ad: <code>${meta.ad||''}</code></p>
  <div class="kpis">${cardKV('Purchase Intention',kpi.PI)}${cardKV('Brand Perception',kpi.BP)}${cardKV('Awareness',kpi.AWR)}${cardKV('Face-tracked frames',`${valid.length} / ${fr.length} (${facePct}%)`)}</div>
  <h2>Emotion Averages (Whole Ad)</h2>${emoGrid(Object.fromEntries(['happy','sad','angry','disgusted','fearful','surprised','neutral'].map(k=>[k,avg(valid.map(v=>+v[k]||0))])))} 
  ${logo?`<h2>Brand Logo ${fmtTs(segs.logo.range.start)}–${fmtTs(segs.logo.range.end)}</h2>${emoGrid(logo.avgEmo)}<div class="kpis">${cardKV('PI',logo.PI)}${cardKV('BP',logo.BP)}${cardKV('AWR',logo.AWR)}${cardKV('Frames',logo.count)}</div>`:''}
  ${cta?`<h2>CTA ${fmtTs(segs.cta.range.start)}–${fmtTs(segs.cta.range.end)}</h2>${emoGrid(cta.avgEmo)}<div class="kpis">${cardKV('PI',cta.PI)}${cardKV('BP',cta.BP)}${cardKV('AWR',cta.AWR)}${cardKV('Frames',cta.count)}</div>`:''}
  ${pack?`<h2>Packshot ${fmtTs(segs.pack.range.start)}–${fmtTs(segs.pack.range.end)}</h2>${emoGrid(pack.avgEmo)}<div class="kpis">${cardKV('PI',pack.PI)}${cardKV('BP',pack.BP)}${cardKV('AWR',pack.AWR)}${cardKV('Frames',pack.count)}</div>`:''}
  <details><summary>Raw frames JSON</summary><pre>${JSON.stringify(fr,null,2)}</pre></details></body></html>`;
}
$('btnCSV').addEventListener('click', ()=> download(`frames_${Date.now()}.csv`, framesCSV(frames), 'text/csv'));
$('btnJSON').addEventListener('click', ()=>{ const k = calcKPIs(); download(`report_${Date.now()}.json`, JSON.stringify({ meta:{ ts:Date.now(), ad:$('adUrl').value }, kpi:k, frames }, null, 2), 'application/json'); });
$('btnReport').addEventListener('click', ()=>{ const k = calcKPIs(); const segs = { logo:{range:parseRange(($('logoRange').value||'').trim())}, cta:{range:parseRange(($('ctaRange').value||'').trim())}, pack:{range:parseRange(($('packRange').value||'').trim())} }; const html = buildReportHTML({ ts:Date.now(), ad:$('adUrl').value }, k, frames, segs); download(`emotion_report_${Date.now()}.html`, html, 'text/html'); });

/* ===== Boot ===== */
diagEl.textContent='DIAG:\\nPage loaded. Booting…\\n';
if (location.protocol!=='https:' && location.hostname!=='localhost'){ document.getElementById('httpsWarn').style.display='block'; }
</script>
</body>
</html>
