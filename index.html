<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Emotion Ad Test — PR / AWR / PI</title>
<style>
  :root { color-scheme: dark; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin:16px; background:#0f1115; color:#fff; }
  .row { display:flex; flex-wrap:wrap; gap:14px; align-items:flex-start; }
  .panel { flex:1 1 360px; border:1px solid #222; border-radius:12px; padding:12px; background:#131722; }
  label { display:block; font-weight:600; margin-top:10px; }
  input[type="text"] { width:100%; padding:8px 10px; border-radius:8px; border:1px solid #333; background:#161a26; color:#fff; }
  .btns { display:flex; gap:10px; align-items:center; margin-top:12px; flex-wrap:wrap; position:relative; z-index:5; }
  button { padding:10px 14px; border:0; border-radius:10px; background:#2a2f3d; color:#fff; cursor:pointer; }
  button:disabled { opacity:.55; cursor:not-allowed; }
  video, canvas { width:100%; border-radius:12px; background:#000; }
  .kpi { display:flex; gap:10px; margin-top:10px; }
  .kpi>div { flex:1 1 0; background:#101520; border:1px solid #222; border-radius:10px; padding:10px; text-align:center; }
  .muted { color:#9aa3b2; font-size:12px; }
  .warn { color:#ffb84d; }
  .ok { color:#5ad08c; }
</style>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.18.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
</head>
<body>

<h2>Emotion Ad Test (Webcam, CV-only KPIs)</h2>

<div class="row">
  <div class="panel" style="flex:1 1 560px;">
    <label>Ad URL (MP4 — HTTPS or repo path like <code>ads/my_ad.mp4</code>)</label>
    <input id="adUrl" type="text" placeholder="ads/my_ad.mp4" />

    <div class="row" style="gap:10px;">
      <div class="panel" style="flex:1 1 260px;">
        <b>Brand moment windows (seconds: start,end)</b>
        <label>Logo</label> <input id="logoWin" type="text" value="5,7.5" />
        <label>Packshot</label> <input id="packWin" type="text" value="10,12" />
        <label>CTA</label> <input id="ctaWin" type="text" value="18,21" />
        <div class="muted" style="margin-top:6px;">Rough timings are fine; refine later.</div>
      </div>
      <div class="panel" style="flex:1 1 260px;">
        <b>Optional rough gaze ROIs (x,y,w,h in 0..1)</b>
        <label>Logo ROI</label> <input id="logoRoi" type="text" value="0.78,0.08,0.18,0.12" />
        <label>Pack ROI</label> <input id="packRoi" type="text" value="0.65,0.30,0.30,0.40" />
        <label>CTA ROI</label> <input id="ctaRoi" type="text" value="0.72,0.80,0.22,0.14" />
        <div class="muted">Uses head yaw/pitch as a rough proxy.</div>
      </div>
    </div>

    <div class="btns">
      <button id="btnLoadModels">1) Load models</button>
      <button id="btnCam" disabled>2) Start webcam</button>
      <button id="btnPlay" disabled>3) Play & analyze</button>
      <button id="btnCSV" disabled>Download CSV</button>
      <button id="btnJSON" disabled>Download JSON</button>
      <span id="status" class="muted">—</span>
    </div>

    <div class="row" style="margin-top:10px;">
      <div style="flex:1 1 380px; position:relative; z-index:1;">
        <video id="ad" controls playsinline></video>
      </div>
      <div style="flex:1 1 220px; position:relative; z-index:1;">
        <video id="cam" autoplay muted playsinline style="width:100%;height:auto;"></video>
        <canvas id="overlay" style="width:100%;height:auto;"></canvas>
        <div class="muted" id="fps">— fps</div>
      </div>
    </div>

    <div class="kpi">
      <div><div class="muted">Positive Recognition</div><div id="kPR">—</div></div>
      <div><div class="muted">Awareness</div><div id="kAWR">—</div></div>
      <div><div class="muted">Purchase Intention</div><div id="kPI">—</div></div>
    </div>
  </div>

  <div class="panel" style="flex:1 1 320px;">
    <b>Tips</b>
    <ul class="muted">
      <li>When webcam starts, you should see your face video on the right.</li>
      <li>Keep your face lit and centered; remove glasses for a first test.</li>
      <li>If the ad is paused or not playing, sampling pauses too.</li>
    </ul>
  </div>
</div>

<script>
  // ====== Config ======
  const MODEL_URL = './models';     // loads from your repo's /models folder
  const SAMPLE_MS = 150;            // ~6–7 Hz
  const BASELINE_PRE = [2.0, 0.5];  // baseline window [te-2.0, te-0.5]
  const RESP_DUR = 2.0;             // response window [te, te+2.0]

  // ====== DOM ======
  const $ = id => document.getElementById(id);
  const ad = $('ad'), cam = $('cam'), canv = $('overlay'), ctx = canv.getContext('2d');
  const kPR = $('kPR'), kAWR = $('kAWR'), kPI = $('kPI'), statusEl = $('status'), fpsEl = $('fps');

  // ====== State ======
  let samplingTimer=null, framesCount=0, fpsT0=performance.now();
  const stream=[];   // {t, att, val, aro, pos, neg, gazeX, gazeY, jitter, face}
  let lastNose=null;
  let webcamReady=false;

  // ====== Utils ======
  const clamp=(x,a,b)=>Math.min(b,Math.max(a,x));
  const mean=a=>a.length?a.reduce((x,y)=>x+y,0)/a.length:0;
  const peak=a=>a.length?Math.max(...a):0;
  const stdev=a=>{ if(!a.length) return 0; const m=mean(a); return Math.sqrt(a.reduce((s,x)=>s+(x-m)*(x-m),0)/a.length); };
  const norm01=(x,min,max)=> max>min?clamp((x-min)/(max-min),0,1):0;
  const sigmoid=x=>1/(1+Math.exp(-x));
  const parsePair = s => { const [a,b]=(s||'').split(',').map(Number); return [Number(a||0),Number(b||0)]; }
  const parseQuad = s => { const [x,y,w,h]=(s||'').split(',').map(Number); return {x:x||0,y:y||0,w:w||0,h:h||0}; }
  const inBox=(x,y,b)=> x>=b.x && x<=b.x+b.w && y>=b.y && y<=b.y+b.h;

  // ====== Face feature helpers ======
  function eyeAspectRatio(p, ids){
    const v = (p[ids[1]].y - p[ids[5]].y + p[ids[2]].y - p[ids[4]].y)/2;
    const h = (p[ids[3]].x - p[ids[0]].x);
    return Math.max(0, v/(Math.abs(h)+1e-5));
  }
  function featuresFromLandmarks(det){
    const p = det.landmarks.positions;
    const earL = eyeAspectRatio(p,[36,37,38,39,40,41]);
    const earR = eyeAspectRatio(p,[42,43,44,45,46,47]);
    const eyesOpen = clamp((earL+earR)/2 * 12, 0, 1);

    const nose = p[30], left=p[2], right=p[14], top=p[27], bottom=p[8];
    const cx=(left.x+right.x)/2, cy=(top.y+bottom.y)/2;
    const yaw  = clamp((nose.x-cx)/(Math.abs(right.x-left.x)+1e-5), -0.6, 0.6);
    const pitch= clamp((nose.y-cy)/(Math.abs(bottom.y-top.y)+1e-5), -0.6, 0.6);

    const gazeX = clamp(0.5 + yaw * -0.9, 0, 1);
   
